---
title: DirecX12 | Lecture 7. Constant Buffer (ì¸í”„ëŸ°)
date: 2025-05-22 16:17:23 +0900
categories: [Study, Study\DirectX]
tags: [DX12, C++, ê°•ì˜ì •ë¦¬, inflearn, Rookiss]
author: "rniman"                            # for single entry
# or
# authors: [<author1_id>, <author2_id>]   # for multiple entries
description: "DirectX12 ê°•ì˜ 7. Constant Bufferë¥¼ ì •ë¦¬í•œ ê¸€ì…ë‹ˆë‹¤."

comments: false # ëŒ“ê¸€ ê¸°ëŠ¥
---

## ê°•ì˜ ì •ë³´ ğŸ“

- ê°•ì˜ëª…: [C++ê³¼ ì–¸ë¦¬ì–¼ë¡œ ë§Œë“œëŠ” MMORPG ê²Œì„ ê°œë°œ ì‹œë¦¬ì¦ˆ - Part2: ê²Œì„ ìˆ˜í•™ê³¼ DirectX12] (https://www.inflearn.com/course/%EC%96%B8%EB%A6%AC%EC%96%BC-3d-mmorpg-2)
- í”Œë«í¼: ì¸í”„ëŸ°
- í˜„ì¬ ì„¹ì…˜: Lecture 7 â€“ Constant Buffer 
- ì£¼ìš” ë‚´ìš©: DirectX 12 Constant Bufferë¥¼ í™œìš©í•˜ì—¬ ì‚¼ê°í˜• ìœ„ì¹˜, ìƒ‰ìƒì„ ìˆ˜ì •í•˜ì—¬ ê·¸ë ¸ë‹¤.
  
---

### 1. Default.hlsliì— Test_B0, Test_B1 constant buffer ì‘ì„±í•œë‹¤.

### 2. RootSignature initì— ì¶”ê°€

```cpp
CD3DX12_ROOT_PARAMETER rootParam[2];
rootParam[0].InitAsConstantBufferView(0); // 0ë²ˆ -> b0 -> CBV
rootParam[1].InitAsConstantBufferView(1); // 1ë²ˆ -> b1 -> CBV

D3D12_ROOT_SIGNATURE_DESC rootSignatureDesc = CD3DX12_ROOT_SIGNATURE_DESC((2, rootParam); // Default ì—ì„œ paramì„ ë„˜ê¸°ë„ë¡ ìˆ˜ì •
```

- `InitAsConstantBufferView`   íŒŒë¼ë¯¸í„°
    1. ë ˆì§€ìŠ¤í„° ë²ˆí˜¸
    2. ë ˆì§€ìŠ¤í„° ê³µê°„ -> ë™ì¼í•œ register ë²ˆí˜¸ë¥¼ **ë‹¤ë¥¸ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹**ì— ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•œë‹¤.
    3. SHADER_VISIBILITY â†’ ë³¼ ìˆ˜ ìˆëŠ” ì…°ì´ë” ë‹¨ê³„ë¥¼ ì„¤ì •í•œë‹¤.

### 3. CommandQueueLayer â†’ RenderBeginì— ì¶”ê°€

```cpp
ComPtr<ID3D12RootSignature> rootSignature = Engine::GetInstance().GetRootSignatureLayer()->GetRootSignature();
mCommandList->SetGraphicsRootSignature(rootSignature.Get());
```

### 4. Mesh â†’ Renderì—ì„œ ë‹¤ìŒì„ ì‘ì„±í•˜ì—¬ë„ ì‘ë™í•˜ì§€ ì•Šì„ ê²ƒì´ë‹¤

 `commandList->SetComputeRootConstantBufferView(0, â€¦)`

1) Bufferì—ë‹¤ê°€ ë°ì´í„° ì„¸íŒ… (ë¦¬ì†ŒìŠ¤ ìƒì„±)â†’ ì¦‰ì‹œ ì¼ì–´ë‚œë‹¤. (Device)

2) Bufferì˜ ì£¼ì†Œë¥¼ registerì—ë‹¤ê°€ ì „ì†¡ â†’ ë‚˜ì¤‘ì— ì¼ì–´ë‚œë‹¤. (CommandList)

ì‹¤í–‰ ì‹œì ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— CommandListì˜ ëª…ë ¹ì´ ì‹¤í–‰ë˜ëŠ” ì‹œì ì—ëŠ” Bufferì˜ ë°ì´í„°ê°€ ì˜ë„í•œ ê°’ì´ ë§ì„ì§€ ìƒê°ì„ í•˜ê³  êµ¬í˜„í•´ì•¼ ë¨!

### 5. ConstantBuffer í´ë˜ìŠ¤ ì‘ì„±

- ConstantBufferë¥¼ ê´€ë¦¬ â†’ í•˜ë‚˜ì˜ CBV
- (size + 255) & ~255; â†’ í•˜ìœ„ 8ë¹„íŠ¸ë¥¼ 0ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ 256 ë°°ìˆ˜ë¡œ ë§Œë“ ë‹¤.
- ì¼ë‹¨ Engineì—ì„œ ê´€ë¦¬ ë° ì´ˆê¸°í™” í˜¸ì¶œ
    - `mConstantBuffer->Init(sizeof(Transform), 256);`
    - CBVëŠ” 64kb = 4096ê°œì˜ ë°±í„° ê¹Œì§€ ë³´ê´€ ê°€ëŠ¥, 256ê°œ ìŠ¬ë¡¯ì„ ì‚¬ìš©í•˜ë©´ Transform ì€ ìµœëŒ€ 64ë°”ì´íŠ¸ê¹Œì§€ í—ˆìš©ëœë‹¤.
- CommandQueue â†’ RenderBeginì—ì„œ ConstantBufferì˜ Clear í˜¸ì¶œ ( ì¸ë±ìŠ¤ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•œë‹¤. )
- mCurrentIndexë¥¼ í†µí•´ì„œ ë²„í¼ê°€ ë®ì—¬ ì“°ì´ëŠ” ê²ƒì„ ë°©ì§€ â†’ Ring-buffer ë°©ì‹
- CBVëŠ” 256ê°œì˜ ì¸ë±ìŠ¤ë¥¼ ë§Œë“¤ì—ˆëŠ”ë° 4ê°œë§Œ ì“°ê³  0, 2ëŠ” b0ì„ 1, 3ì€ b1ì„ ì‚¬ìš©í•œë‹¤.

### 6. Renderì—ì„œ PushData í˜¸ì¶œ

```cpp
Engine::GetInstance().GetConstantBuffer()->PushData(0, &mTransform, sizeof(Transform)); // b0ì— mTransform ì •ë³´ë¥¼ ë„£ìŒ
Engine::GetInstance().GetConstantBuffer()->PushData(1, &mTransform, sizeof(Transform)); // b1ì— mTransform ì •ë³´ë¥¼ ë„£ìŒ
```

### 7. Client í”„ë¡œì íŠ¸ Game::Update ìˆ˜ì •

```cpp
	{
		Transform t;
		t.offset = Vec4(0.75f, 0.0f, 0.0f, 0.0f);

		mesh->SetTransform(t);

		mesh->Render();
	}

	{
		Transform t;
		t.offset = Vec4(0.0f, 0.75f, 0.0f, 0.0f);

		mesh->SetTransform(t);

		mesh->Render();
	}
```

---

### ConstantBufferì™€ CBV í™œìš© ë°©ì‹ ì •ë¦¬

1. **í•˜ë‚˜ì˜ ConstantBuffer(ID3D12Resource)ë¥¼ ì—¬ëŸ¬ ì¸ë±ìŠ¤ë¡œ ìª¼ê°œì„œ ê´€ë¦¬í•œë‹¤.**
    - ì‹¤ì œë¡œ GPUì— ì˜¬ë¼ê°€ëŠ” ë¦¬ì†ŒìŠ¤ëŠ” **í•˜ë‚˜ì˜ CBVìš© ë¦¬ì†ŒìŠ¤**ì§€ë§Œ,
    - ë‚´ë¶€ë¥¼ `256-byte aligned` ë‹¨ìœ„ë¡œ ì˜ë¼ì„œ ë§ˆì¹˜ **ìŠ¬ë¡¯ì²˜ëŸ¼ êµ¬ë¶„í•˜ì—¬ ì‚¬ìš©**í•¨.
    - ë§Œì•½ ì´ ì¸ë±ìŠ¤ ê°œë… ì—†ì´ ë§¤ë²ˆ ê°™ì€ ìœ„ì¹˜ì— ë°ì´í„°ë¥¼ ì“°ë©´, **ì—¬ëŸ¬ ë²ˆì˜ Render í˜¸ì¶œ ì‹œ ìµœì¢… ê°’ë§Œ ì ìš©**ë˜ì–´, **ëª¨ë“  ì˜¤ë¸Œì íŠ¸ê°€ ë™ì¼í•œ Transformìœ¼ë¡œ ê·¸ë ¤ì§€ëŠ” ë¬¸ì œ**ê°€ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìƒê¸´ë‹¤.
2. ê° ì¸ë±ìŠ¤ì—ëŠ” `Transform t` êµ¬ì¡°ì²´ì˜ ë°ì´í„°ë¥¼ ë³µì‚¬í•´ ë„£ëŠ”ë‹¤.
3. ì²« ë²ˆì§¸ `Render()` ì‹œ:
    - `PushData(0, &t)` â†’ **CBV ìŠ¬ë¡¯ 0** â†’ ë£¨íŠ¸ íŒŒë¼ë¯¸í„° **b0**ì— ì—°ê²°
    - `PushData(1, &t)` â†’ **CBV ìŠ¬ë¡¯ 1** â†’ ë£¨íŠ¸ íŒŒë¼ë¯¸í„° **b1**ì— ì—°ê²°
4. ì´í›„ `Transform t` ê°’ì„ ìˆ˜ì •í•œë‹¤.
    - ë§Œì•½ ì¸ë±ìŠ¤ ì—†ì´ ê°™ì€ ìŠ¬ë¡¯(CBV 0 ê°™ì€ ê³³)ì— ê³„ì† ì“°ë©´, **ë®ì–´ì“°ê¸°**ê°€ ë°œìƒí•¨.
    - ì´ ê²½ìš° GPUëŠ” í•­ìƒ **ê°€ì¥ ë§ˆì§€ë§‰ ê°’ë§Œ** ë³´ê²Œ ë˜ì–´, **ì„œë¡œ ë‹¤ë¥¸ Transformì´ ì ìš©ë˜ì§€ ì•ŠìŒ.**
    - ì°¸ê³ : ì•„ë˜ ì½”ë“œì²˜ëŸ¼ ë‹¨ìˆœ 2ìŠ¬ë¡¯ì„ ë²ˆê°ˆì•„ ì“°ëŠ” ê²½ìš°ë„ **í”„ë ˆì„ ë‚´ì—ì„œ ì—¬ëŸ¬ ì˜¤ë¸Œì íŠ¸ë¥¼ ê·¸ë¦¬ë©´ ê°™ì€ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥**:
        
        ```cpp
        mCurrentIndex++;
        if (mCurrentIndex > 1)
            mCurrentIndex = 0;
        ```
        
        â†’ ë‘ ê°œì˜ ìŠ¬ë¡¯ë§Œìœ¼ë¡œëŠ” **ë™ì¼ í”„ë ˆì„ ë‚´ ì—¬ëŸ¬ ì˜¤ë¸Œì íŠ¸ë¥¼ ê·¸ë¦´ ìˆ˜ ì—†ìŒ.**
        
5. ë‘ ë²ˆì§¸ `Render()` ì‹œ:
    - `PushData(0, &t)` â†’ **CBV ìŠ¬ë¡¯ 2** â†’ ë£¨íŠ¸ íŒŒë¼ë¯¸í„° **b0**ì— ì—°ê²°
    - `PushData(1, &t)` â†’ **CBV ìŠ¬ë¡¯ 3** â†’ ë£¨íŠ¸ íŒŒë¼ë¯¸í„° **b1**ì— ì—°ê²°
6. ê²°ê³¼ì ìœ¼ë¡œ:
    - ì²« ë²ˆì§¸ `Render()`ëŠ” **`t` ìˆ˜ì • ì „ì˜ ì˜¤ë¸Œì íŠ¸**
    - ë‘ ë²ˆì§¸ `Render()`ëŠ” **`t` ìˆ˜ì • í›„ì˜ ì˜¤ë¸Œì íŠ¸**
    - â†’ ê°ê¸° ë‹¤ë¥¸ ìœ„ì¹˜ì— ê·¸ë ¤ì§€ëŠ” ë‘ ê°œì˜ ì‚¼ê°í˜•ì´ ë Œë”ë§ë¨ âœ…

---

### ì°¸ê³ 

Device í•¨ìˆ˜ë“¤ â†’ ë‹¹ì¥ ë­”ê°€ê°€ ì¼ì–´ë‚œë‹¤.

CommandQueue â†’ ë‚˜ì¤‘ì— ëª°ì•„ì„œ ì¼ì–´ë‚œë‹¤. ( ì‹¤í–‰ ì‹œì  )

ëª¨ë¸ ê³„ì¸µ êµ¬ì¡°ì—ì„œ CBVê°€ ìì‹ë§ˆë‹¤ í•„ìš”í•œ ì´ìœ 

1. **Transformì€ ê³„ì¸µì ìœ¼ë¡œ ëˆ„ì ëœë‹¤**

   - ìì‹ ë…¸ë“œëŠ” ìì‹ ì˜ ë¡œì»¬ ë³€í™˜(Local Transform)ì„ ê°€ì§€ê³  ìˆë‹¤.
   - ë Œë”ë§ ì‹œì—ëŠ” `ë¶€ëª¨ì˜ ì›”ë“œ ë³€í™˜ Ã— ìì‹ ì˜ ë¡œì»¬ ë³€í™˜`ì„ ê³„ì‚°í•´ì„œ **ì›”ë“œ í–‰ë ¬(World Transform)** ìƒì„±í•œë‹¤.

   ```cpp
   XMMATRIX world = XMMatrixMultiply(child->local, parent->world);
   ```

2. **ìì‹ë§ˆë‹¤ ì›”ë“œ í–‰ë ¬ì´ ë‹¤ë¥´ë‹¤**

   - ë¶€ëª¨ì˜ ìœ„ì¹˜ê°€ (0, 1, 0)ì¼ ë•Œ:

   | ìì‹   | ë¡œì»¬ ìœ„ì¹˜ | ìµœì¢… ìœ„ì¹˜ (ì›”ë“œ) |
   | ------ | --------- | ---------------- |
   | ìì‹ 1 | (1, 0, 0) | (1, 1, 0)        |
   | ìì‹ 2 | (0, 0, 1) | (0, 1, 1)        |

   â†’ ê²°ê³¼ì ìœ¼ë¡œ ê° ìì‹ì˜ ì›”ë“œ í–‰ë ¬ì´ ë‹¤ë¥´ë©°,

   â†’ **ì…°ì´ë”ì—ì„œ ì°¸ì¡°í•  ê°’ì´ ê°ê° ë‹¬ë¼ì§„ë‹¤.**

3. **ê·¸ë˜ì„œ ê° ìì‹ì€ ì„œë¡œ ë‹¤ë¥¸ CBV ìŠ¬ë¡¯ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤**

   - CBVëŠ” GPUì— ì „ë‹¬í•  `Transform` ë°ì´í„°ë¥¼ ë‹´ëŠ” ë²„í¼
   - ë§Œì•½ í•˜ë‚˜ì˜ CBVë§Œ ì‚¬ìš©í•˜ë©´, ì—¬ëŸ¬ ìì‹ì´ ê°™ì€ ë²„í¼ì— ë®ì–´ì“°ë©° **ëª¨ë‘ ê°™ì€ ìœ„ì¹˜ì— ë Œë”ë§ë˜ëŠ” ë¬¸ì œ ë°œìƒí•œë‹¤.**
   - ë”°ë¼ì„œ **`PushData()`ë¡œ ê° ìì‹ì˜ Transformì„ ë…ë¦½ëœ ìŠ¬ë¡¯ì— ë³µì‚¬**í•´ì•¼ í•œë‹¤.

   ```cpp
   // ê° ìì‹ ë…¸ë“œë§ˆë‹¤
   constantBuffer->PushData(0, &worldMatrix, sizeof(Transform)); // ìŠ¬ë¡¯ ì¸ë±ìŠ¤ ì¦ê°€
   ```

4. **CBVëŠ” Transform ë°ì´í„° ì „ì†¡ìš©ì´ë©°, ìœ„ì¹˜ê°€ ë‹¤ë¥´ë©´ ë°˜ë“œì‹œ ë‚˜ëˆ ì•¼ í•œë‹¤**

   - `Transform` â‰  `Mesh` â‰  `Material`
   - ë™ì¼í•œ ë©”ì‹œ(geometry)ë¥¼ ê³µìœ í•˜ë”ë¼ë„, ìœ„ì¹˜ê°€ ë‹¤ë¥´ë©´ `CBV`ëŠ” ë¶„ë¦¬í•´ì•¼ í•¨

---

Descriptor Table ì˜ˆì‹œ

```
[ Descriptor Heap ]
| CBV 0 | CBV 1 | CBV 2 | CBV 3 | CBV 4 | ...
   â†‘       â†‘       â†‘       â†‘       â†‘
 ë³¸ì²´     íŒ”      ë‹¤ë¦¬     ë¨¸ë¦¬     ê¼¬ë¦¬
```

Root Descriptor(Ring-Buffer) ì˜ˆì‹œ

```
ConstantBuffer ë¦¬ì†ŒìŠ¤ (í•˜ë‚˜)
[ ìŠ¬ë¡¯ 0 ][ ìŠ¬ë¡¯ 1 ][ ìŠ¬ë¡¯ 2 ][ ìŠ¬ë¡¯ 3 ][ ìŠ¬ë¡¯ 4 ] ...
   â†‘         â†‘         â†‘         â†‘         â†‘
 ë³¸ì²´       íŒ”        ë‹¤ë¦¬       ë¨¸ë¦¬       ê¼¬ë¦¬
```

> CBV 5ê°œ ê°ê°ì— ë¡œì»¬ í–‰ë ¬ì„ ê°€ì§ vs í•˜ë‚˜ì˜ CBVì— 5ê°œì˜ ìŠ¬ë¡¯ìœ¼ë¡œ í‘œí˜„ë¨
> 

**ê²°ë¡ **

> ëª¨ë¸ì—ì„œ ë¶€ëª¨-ìì‹ ê´€ê³„ê°€ ìˆì„ ë•Œ, **ìì‹ë§ˆë‹¤ CBVê°€ í•„ìš”í•œ ì´ìœ ëŠ” ê°ê°ì˜ ìµœì¢… ì›”ë“œ ë³€í™˜ í–‰ë ¬ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì´ë©°**, **ì´ë¥¼ GPUì— ì „ë‹¬í•˜ê¸° ìœ„í•´ ê° ìì‹ì€ ë…ë¦½ëœ CBV ìŠ¬ë¡¯ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**
> 

---

## í”„ë¡œì íŠ¸ ìƒíƒœ ğŸ’¾

![04Result.png](assets/img/DX12/01_INFLEARN/04Result.png)
